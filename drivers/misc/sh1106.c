
#include <linux/module.h>
#include <linux/i2c.h>
#include <linux/bcd.h>
#include <linux/rtc.h>
#include <linux/delay.h>
#include <linux/of_gpio.h>
#include <linux/gpio.h>
#include <linux/platform_device.h>

#define SH1106_IIC_SPEED (200 * 1000)
#define OP_CMD 0x00
#define OP_DATA 0x40
struct sh1106_gpio {
	int gpio;
	enum of_gpio_flags flags;
};
struct sh1106_info {
    struct sh1106_gpio gpio_blen;
    struct sh1106_gpio gpio_lcda0;
    struct sh1106_gpio gpio_reset;
    struct sh1106_gpio gpio_lcden;
    struct device_node *p_node;
    struct platform_device *p_pltdev;
    struct i2c_client *p_client;
    int i2cdvr_added;
};

uint8_t tab_1[]={
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0XE0,0X18,0X04,0X04,0X04,0X04,
0X18,0XE0,0X00,0X00,0XE0,0X18,0X04,0X04,0X04,0X04,0X18,0XE0,0X00,0X00,0XF0,0X08,
0X04,0X04,0X04,0X04,0X18,0XE0,0X00,0X00,0XF0,0X08,0X04,0X04,0X04,0X04,0X18,0XE0,
0X00,0X00,0X00,0X08,0X08,0XFC,0X00,0X00,0X00,0X00,0X00,0X00,0X80,0X80,0X80,0X80,
0X80,0X80,0X80,0X80,0X80,0X18,0X04,0X04,0X04,0XFC,0X04,0X04,0X04,0X18,0X00,0XC0,
0X30,0X08,0X04,0X04,0X04,0X04,0X08,0X3C,0X00,0X00,0X00,0X08,0X08,0XFC,0X00,0X00,
0X00,0X00,0X00,0X00,0X80,0X80,0X80,0X80,0X80,0X80,0X80,0X80,0X80,0X00,0X00,0X00,
0XF0,0X0C,0XF0,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X0F,0X30,0X40,0X40,0X40,0X40,
0X30,0X0F,0X00,0X00,0X0F,0X30,0X40,0X40,0X40,0X40,0X30,0X0F,0X00,0X00,0X30,0X41,
0X42,0X42,0X42,0X22,0X19,0X07,0X00,0X00,0X30,0X41,0X42,0X42,0X42,0X22,0X19,0X07,
0X00,0X00,0X00,0X40,0X40,0X7F,0X40,0X40,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X40,0X7F,0X40,0X00,0X00,0X00,0X00,0X0F,
0X30,0X20,0X40,0X40,0X40,0X40,0X20,0X18,0X00,0X00,0X00,0X40,0X40,0X7F,0X40,0X40,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X40,0X70,0X4F,
0X04,0X04,0X04,0X4F,0X70,0X40,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
};

//
//
//

uint8_t tab_2[]={
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X02,0X02,0X06,0X84,
0X68,0X10,0X90,0XA8,0X04,0X04,0X80,0XFE,0X44,0X20,0X20,0X00,0X80,0X80,0X80,0XFF,
0X40,0X40,0X40,0X40,0X80,0X80,0XFE,0X40,0X20,0X10,0X08,0X00,0X00,0X00,0X30,0X20,
0X40,0X00,0X00,0XFE,0X04,0X00,0X00,0X70,0X18,0X00,0X00,0X00,0X00,0X04,0X04,0XC4,
0X24,0X14,0XFC,0X04,0X04,0XFC,0X02,0X12,0X22,0X02,0X02,0X00,0X00,0X00,0X38,0X24,
0X24,0X24,0XFC,0XA0,0X90,0X88,0X14,0XF8,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0XBC,
0XA4,0X54,0X54,0X5C,0X00,0X00,0X00,0XFE,0X00,0X00,0X80,0X00,0X00,0X08,0X48,0X48,
0XF8,0XA4,0X04,0XFF,0X00,0XA0,0X50,0X50,0XC8,0X08,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X09,
0X09,0X7F,0X04,0X04,0X00,0X04,0X04,0X7F,0X02,0X02,0X00,0X00,0X00,0X00,0X00,0X7F,
0X00,0X05,0X0A,0X00,0X22,0X12,0X0F,0X09,0X09,0X01,0X00,0X00,0X00,0X02,0X02,0X02,
0X22,0X22,0X12,0X11,0X11,0X11,0X11,0X01,0X01,0X01,0X00,0X00,0X00,0X00,0X00,0X00,
0X3C,0X22,0X2A,0X2A,0X15,0X15,0X17,0X18,0X00,0X00,0X00,0X00,0X01,0X11,0X11,0X79,
0X0D,0X0B,0X3C,0X28,0X08,0X00,0X10,0X23,0X02,0X01,0X01,0X00,0X08,0X08,0X08,0X0A,
0X1A,0X29,0X05,0X05,0X04,0X04,0X30,0X0F,0X02,0X01,0X00,0X00,0X00,0X00,0X05,0X0D,
0X13,0X22,0X18,0X07,0X02,0X04,0X32,0X0B,0X06,0X02,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X10,0X30,0X70,
0XF0,0XD0,0X80,0X50,0X30,0X10,0X10,0X00,0X80,0XE0,0XF0,0X10,0X10,0X10,0XF0,0XE0,
0X80,0X00,0X00,0X10,0XF0,0XF0,0X10,0X10,0X10,0XF0,0XF0,0X10,0X00,0X00,0X80,0XE0,
0XF0,0X10,0X10,0X10,0XF0,0XE0,0X80,0X00,0X10,0XF0,0XF0,0XF0,0X00,0X00,0XE0,0XF0,
0X90,0X10,0X20,0X20,0X00,0X10,0XF0,0XF0,0XF0,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0XE0,0XF0,0XE0,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X20,0X30,
0X29,0X07,0X3F,0X3E,0X38,0X20,0X00,0X00,0X07,0X1F,0X1F,0X20,0X20,0X20,0X3F,0X1F,
0X07,0X00,0X00,0X00,0X1F,0X3F,0X30,0X20,0X10,0X3F,0X3F,0X20,0X00,0X00,0X07,0X1F,
0X1F,0X20,0X20,0X20,0X3F,0X1F,0X07,0X00,0X00,0XBF,0XBF,0X3F,0X00,0X00,0X01,0X13,
0X23,0X27,0X3E,0X1C,0X00,0X00,0XBF,0XBF,0X3F,0X00,0X00,0X00,0X80,0X20,0X0C,0X03,
0X00,0X07,0X1F,0XFF,0XFC,0XE0,0X80,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X03,0X03,0X01,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X03,0X03,0X01,0X00,0X02,0X03,0X03,0X02,0X02,0X00,
0X00,0X00,0X02,0X02,0X03,0X03,0X03,0X02,0X02,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
};


static struct sh1106_info g_sh1106_info;
static uint8_t sh1106_init_cmds[] = {
    0xAE,
    0xD5,
    0x80,
    0xA8,
    0x3F,
    0xD3,
    0x00,
    0x40,
    0xAD,
    0x8B,
    0x32,
    0xA1,
    0xC8,
    0xDA,
    0x12,
    0x81,
    0x40,
    0xD9,
    0x1F,
    0xDB,
    0x40,
    0xA4,
    0xA6,
    0xAF,
};

static void sh1106_wr_cmd(struct sh1106_info *p_info, uint8_t cmd)
{
    i2c_master_reg8_send(p_info->p_client, OP_CMD, &cmd, 1, SH1106_IIC_SPEED);
}
static void sh1106_wr_data(struct sh1106_info *p_info, uint8_t data)
{
    i2c_master_reg8_send(p_info->p_client, OP_DATA, &data, 1, SH1106_IIC_SPEED);
}

static int sh1106_probe(struct i2c_client *client, const struct i2c_device_id *id)
{
	int rc = 0;
    struct sh1106_info *p_info = &g_sh1106_info;
    int i, j, k;
    uint8_t cmd;

    printk("wangluheng: entered %s, blen=%d, lcden=%d\n",
        __FUNCTION__, g_sh1106_info.gpio_blen.gpio, g_sh1106_info.gpio_lcden.gpio);
	if (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C)) {
        printk("wangluheng: check sh1106 i2c func error\n");
		return -ENODEV;
	}
    printk("wangluheng: check sh1106 i2c func OK!\n");

    p_info->p_client = client;

    for (i = 0; i < (sizeof(sh1106_init_cmds)/sizeof(sh1106_init_cmds[0])); i++) {
        cmd = sh1106_init_cmds[i];
        sh1106_wr_cmd(p_info, cmd);
    }

    k = 0;
    for (i = 0; i < 8; i++) {
        sh1106_wr_cmd(p_info, 0xB0 + i);
        sh1106_wr_cmd(p_info, 0x10);
        sh1106_wr_cmd(p_info, 0x02);
        for (j = 0; j < 128; j++) {
            sh1106_wr_data(p_info, tab_2[k]);
            k++;
        }
    }


	return rc;
}

static int sh1106_remove(struct i2c_client *client)
{
    printk("wangluheng: entered %s\n", __FUNCTION__);

	return 0;
}

void sh1106_shutdown(struct i2c_client * client)
{
    /* don't disable clockout here */
}



static const struct i2c_device_id sh1106_id[] = {
	{ "lcd_sh1106", 0 },
	{ }
};
MODULE_DEVICE_TABLE(i2c,sh1106_id);
static const struct of_device_id sh1106_dt_ids[] = {
	{ .compatible = "sino,sh1106", },
	{ /* sentinel */ }
};
MODULE_DEVICE_TABLE(of,sh1106_dt_ids);


static struct i2c_driver sh1106_driver = {
	.driver		= {
		.name	= "lcd_sh1106",
		.owner	= THIS_MODULE,
		.of_match_table = sh1106_dt_ids,
	},
	.probe		= sh1106_probe,
	.remove		= sh1106_remove,
	.shutdown   = sh1106_shutdown,
	.id_table	= sh1106_id,
};

static void sh1106_enable_gpio(struct sh1106_gpio *pgpio, bool enable)
{
	int value;

	if (OF_GPIO_ACTIVE_LOW == pgpio->flags) {
		if (enable)
			value = 0;
		else
			value = 1;
	} else {
		if (enable)
			value = 1;
		else
			value = 0;
	}

	gpio_set_value_cansleep(pgpio->gpio, value);
}
static int sh1106_get_gpio(struct sh1106_info *p_info, struct sh1106_gpio *pgpio, char *gpioname)
{
    struct platform_device *pdev = p_info->p_pltdev;
    struct device_node *np = p_info->p_node;
	unsigned long init_flags;
	int ret;

	pgpio->gpio  = of_get_named_gpio_flags(np, gpioname, 0, &(pgpio->flags));
	if (pgpio->gpio < 0) {
		printk("%s cannot get %s!\n", __FUNCTION__, gpioname);
		ret = -EFAULT;
	} else {
		/* init as inactive */
		if (OF_GPIO_ACTIVE_LOW == pgpio->flags) {
			init_flags = GPIOF_OUT_INIT_HIGH;
		} else {
			init_flags = GPIOF_OUT_INIT_LOW;
		}

		ret = devm_gpio_request_one(&(pdev->dev), (unsigned int)(pgpio->gpio), init_flags, gpioname);
		if (ret) {
			pgpio->gpio = -1;
			dev_err(&pdev->dev, "failed to request %s: %d\n", gpioname, ret);
		}
	}

	return ret;
}
static int dummy_sh1106_probe(struct platform_device *pdev)
{
    int ret = -1;
    struct sh1106_info *p_info = &g_sh1106_info;

    p_info->p_pltdev = pdev;

    if (!(p_info->p_node = of_find_compatible_node(NULL, NULL, "sino,sh1106"))) {
        printk("Err: %s, failed to get device-tree-node\n", __FUNCTION__);
        goto out;
    }

    sh1106_get_gpio(p_info, &(p_info->gpio_blen),  "blen-gpios");
    sh1106_get_gpio(p_info, &(p_info->gpio_lcda0), "lcda0-gpios");
    sh1106_get_gpio(p_info, &(p_info->gpio_reset), "lcdrst-gpios");
    sh1106_get_gpio(p_info, &(p_info->gpio_lcden), "lcden-gpios");

    sh1106_enable_gpio(&(p_info->gpio_lcda0), 1);
    sh1106_enable_gpio(&(p_info->gpio_lcden), 1);
    sh1106_enable_gpio(&(p_info->gpio_blen), 1);

    msleep(1);
    sh1106_enable_gpio(&(p_info->gpio_reset), 0);
    msleep(1);
    sh1106_enable_gpio(&(p_info->gpio_reset), 1);
    msleep(50);
    sh1106_enable_gpio(&(p_info->gpio_reset), 0);
    msleep(100);

    if (!i2c_add_driver(&sh1106_driver)) {
        g_sh1106_info.i2cdvr_added = 1;
    }
    ret = 0;
out:
    if (ret) {
        p_info->p_pltdev = NULL;
    }
	return 0;
}
int dummy_sh1106_suspend(struct platform_device *pdev, pm_message_t state) { return 0; }
int dummy_sh1106_resume(struct platform_device *pdev) { 	return 0; }
void dummy_sh1106_shutdown(struct platform_device *pdev) { };
static struct platform_driver dummy_sh1106_driver = {
	.probe		= dummy_sh1106_probe,
	/*.shutdown	= dummy_sh1106_shutdown,
	.suspend	= dummy_sh1106_suspend,
	.resume		= dummy_sh1106_resume, */
	.driver	= {
		.name	= "dummy_sh1106",
		.owner	= THIS_MODULE,
	},
};
static struct platform_device *p_dummy_sh1106_dev;
/*= {
    .name = "dummy_sh1106",
};*/
static int __init sh1106_init(void)
{
    p_dummy_sh1106_dev = platform_device_alloc("dummy_sh1106", 0);
    
    platform_device_add(p_dummy_sh1106_dev);
	return platform_driver_register(&dummy_sh1106_driver);
}

static void __exit sh1106_exit(void)
{
	platform_driver_unregister(&dummy_sh1106_driver);
    platform_device_unregister(p_dummy_sh1106_dev);

    if (g_sh1106_info.i2cdvr_added) {
        i2c_del_driver(&sh1106_driver);
    }
}

MODULE_AUTHOR("wlh wlh@intelligen.com");
MODULE_DESCRIPTION("LCD sh1106 driver");
MODULE_LICENSE("GPL");

module_init(sh1106_init);
module_exit(sh1106_exit);

